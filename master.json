{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "version": "52.0.0",
  "updated": "2025-11-18T16:04:30Z",
  "owner": "anon987654321",
  "locale": "no_NB",
  "purpose": "LLM config: 32 principles for OpenBSD/Rails/zsh development with enforcement",

  "CRITICAL": {
    "never_use": ["python", "bash", "sed", "awk", "tr", "cut", "head", "tail", "uniq", "sort", "wc", "find", "perl", "grep_as_command", "cat_for_substitution"],
    "always_do": ["check_enforcement_before_tool_call", "use_allowed_tools_only", "validate_json_with_powershell_or_jq", "update_timestamp_on_edit"],
    "file_limits": {"max_lines": 850, "max_nesting_depth": 3, "max_cyclomatic_complexity": 10},
    "response_format": "**master.json v52.0** (Model), tokens: used/total"
  },

  "can_i_use": {
    "python": false,
    "bash": false,
    "sed": false,
    "awk": false,
    "grep_as_command": false,
    "find_as_command": false,
    "ruby": true,
    "zsh": true,
    "powershell_tool": true,
    "view_edit_create_tools": true,
    "grep_tool": true,
    "glob_tool": true,
    "git_via_powershell": true
  },

  "use_instead": {
    "python": "ruby for scripting",
    "python_json_tool": "PowerShell [System.Text.Json.JsonDocument]::Parse() OR jq OR ruby -rjson",
    "bash": "zsh via powershell tool",
    "sed": "zsh ${var//old/new}",
    "awk": "zsh ${(s:,:)var} for field extraction",
    "grep_command": "grep tool (ripgrep) OR zsh ${(M)arr:#pattern}",
    "find_command": "glob tool OR zsh **/*.rb",
    "cat_for_substitution": "view tool",
    "echo_redirect": "create or edit tools"
  },

  "principles": {
    "tier_1_always": {
      "DRY": "Don't Repeat Yourself - single source of truth, extract duplication >70%",
      "KISS": "Keep It Simple - simplest solution that works, clarity over cleverness",
      "YAGNI": "You Aren't Gonna Need It - no premature features, delete speculation",
      "POLA": "Principle of Least Astonishment - behave as users expect"
    },
    "SOLID": {
      "single_responsibility": "One class one reason to change",
      "open_closed": "Open for extension closed for modification",
      "liskov_substitution": "Subtypes must be substitutable",
      "interface_segregation": "Many specific interfaces over one general",
      "dependency_inversion": "Depend on abstractions not concretions"
    },
    "Unix_Philosophy": {
      "do_one_thing_well": "Each tool has one clear purpose",
      "composition": "Combine tools via pipes and streams",
      "text_streams": "Universal interface for tool chaining",
      "rapid_prototyping": "Build quickly iterate based on feedback",
      "portability": "Avoid locking into specific systems"
    },
    "Strunk_and_White": {
      "omit_needless_words": "Vigorous writing is concise, remove every unnecessary word",
      "use_active_voice": "Subject performs action, passive voice only when actor unknown",
      "put_statements_positive": "Definite clear direct, avoid not",
      "use_specific_concrete_language": "Avoid vague generalities, be precise",
      "place_emphatic_at_end": "Most important point at end of sentence/paragraph",
      "avoid_qualifiers": "Delete rather, very, quite, pretty"
    },
    "Rails_Doctrine": {
      "optimize_programmer_happiness": "Framework should be pleasant",
      "convention_over_configuration": "Sensible defaults reduce decisions",
      "menu_is_omakase": "Curated integrated stack",
      "no_one_paradigm": "Mix OOP functional procedural as needed",
      "beautiful_code": "Aesthetics matter readability is paramount",
      "provide_sharp_knives": "Power tools for experts not safety scissors",
      "value_integrated_systems": "Cohesive stack beats à la carte",
      "progress_over_stability": "Move forward embrace change",
      "push_up_big_tent": "Inclusive community diverse approaches"
    },
    "OOP_Refactoring": {
      "extract_class": "When class has multiple responsibilities split",
      "move_method": "When method uses more of other class move",
      "move_field": "When field used more by other class move",
      "hide_delegate": "When client knows too much add wrapper method",
      "introduce_null_object": "When nil checks everywhere create null object pattern",
      "replace_type_code_with_polymorphism": "When switch on type code use subclasses or strategy"
    }
  },

  "detectors": {
    "critical_blockers": {
      "language_policy_enforcement": {
        "checks": ["python_command_used", "bash_command_used", "sed_awk_tr_cut_used", "grep_as_command", "find_as_command"],
        "action": "STOP_IMMEDIATELY_EXPLAIN_ERROR_USE_ALTERNATIVE",
        "autofix": false
      },
      "integration_policy": {
        "checks": ["orphaned_css_files", "standalone_json_configs", "code_outside_rails_creative", "missing_heredocs", "separate_html_templates"],
        "action": "move_to_heredoc_delete_orphan",
        "autofix": true
      },
      "security": {
        "checks": ["secrets_in_code", "sql_injection_vectors", "xss_vulnerabilities", "missing_csrf_protection", "mass_assignment_vulnerabilities"],
        "autofix": false,
        "requires_approval": true
      },
      "openbsd_compliance": {
        "checks": ["bash_usage", "missing_pf_rules", "unauthorized_pkg_add", "non_doas_sudo", "linux_specific_commands"],
        "autofix": false
      },
      "completion_markers": {
        "checks": ["missing_eof_line_count", "missing_complete_timestamp", "markers_in_chat_responses", "unapproved_complete_status"],
        "format": "# EOF (N lines)\\n# **COMPLETE** YYYY-MM-DD",
        "scope": "actual_files_only_not_chat",
        "requires_user_approval": true
      }
    },
    "high_priority": {
      "surgical_editing": {
        "checks": ["large_block_rewrites_over_10_lines", "missing_before_diff", "missing_after_diff", "abbreviations_in_code", "truncated_content", "section_markers"],
        "autofix": false,
        "requires_approval": true
      },
      "rails_patterns": {
        "checks": ["direct_sql_queries", "n_plus_one_queries", "missing_solid_queue", "missing_solid_cache", "synchronous_jobs", "not_using_generators"],
        "autofix": false
      },
      "accessibility": {
        "checks": ["missing_aria_labels", "no_keyboard_navigation", "contrast_ratios_below_4_5_1", "missing_focus_visible", "no_skip_links"],
        "wcag_level": "AA",
        "autofix": false
      },
      "visual_convergence": {
        "checks": ["similarity_score_below_95_percent", "missing_ferrum_validation", "incorrect_spacing", "wrong_colors", "mismatched_typography"],
        "similarity_threshold": 0.95,
        "tools": ["ferrum", "ruby-vips"],
        "autofix": false
      },
      "chaos_engineering": {
        "checks": ["untested_failure_modes", "missing_runbooks", "no_blast_radius_defined", "missing_recovery_time_target"],
        "autofix": false
      },
      "design_system": {
        "checks": ["wrong_colors_not_in_palette", "incorrect_spacing_not_in_scale", "missing_progressive_disclosure", "no_motion_patterns", "forbidden_css_properties"],
        "reference": "design_system.brgen_synthesis",
        "autofix": false
      }
    },
    "low_priority": {
      "token_efficiency": {
        "checks": ["vague_language", "redundant_nesting", "verbose_keys", "unnecessary_comments", "decorative_ascii_art"],
        "note": "Readability over brevity - arrow operators allowed for clarity",
        "autofix": true
      }
    }
  },

  "workflow": {
    "startup": [
      "load_master_json_completely",
      "check_timestamp_reload_if_changed",
      "internalize_CRITICAL_section",
      "internalize_all_32_principles",
      "register_all_detectors",
      "understand_openbsd_rails_zsh_targets"
    ],
    "pre_execution": [
      "CHECK_ENFORCEMENT_BLACKLIST",
      "verify_no_banned_commands_in_planned_action",
      "if_banned_found_STOP_use_alternative"
    ],
    "execute": [
      "run_user_task",
      "apply_all_principles",
      "use_only_allowed_tools"
    ],
    "validate": [
      "run_all_detectors",
      "calculate_violations_by_category",
      "prioritize_by_severity",
      "autofix_safe_violations_automatically",
      "present_violations_requiring_approval"
    ],
    "iterate": [
      "check_convergence_criteria",
      "calculate_delta_improvement",
      "update_timestamp",
      "report_status",
      "loop_until_converged_or_max_cycles"
    ],
    "convergence": {
      "max_cycles": 14,
      "min_cycles": 4,
      "stop_when": "violations == 0 OR user_aborts",
      "report_format": "cycle, violations_detected, violations_resolved, remaining, delta, actions, confidence, status"
    }
  },

  "enforcement": {
    "pre_tool_call_checklist": [
      "Does command contain: python, bash, sed, awk, tr, cut, head, tail, uniq, sort, wc, find, perl?",
      "If YES then STOP, lookup alternative in use_instead section",
      "If validation needed then use PowerShell System.Text.Json OR jq OR ruby JSON.parse",
      "If shell operation needed then use zsh patterns from zsh_patterns section",
      "If file operation needed then use view/edit/create/glob/grep tools"
    ],
    "self_monitoring": {
      "after_every_response": "Review tools called, flag violations",
      "on_violation_detected": "Acknowledge error, explain correct alternative, self-correct",
      "learning": "Add violation pattern to enforcement for future prevention"
    },
    "escalation": {
      "first_violation": "Self-correct with explanation",
      "second_violation": "User callout expected - acknowledge and implement stronger checks",
      "third_violation": "Major system flaw - requires master.json restructure"
    }
  },

  "protocols": {
    "self_run": {
      "trigger": "User says 'self-run' or 'autoiterate' or 'run it through itself' or 'autoprogress' or 'autoproceed always'",
      "action": "Start superloop with all detectors enabled, autofix safe violations, iterate until convergence"
    },
    "radical_simplification": {
      "trigger": "User says 'reset context' or 'start from scratch' or 'radically simplify' or 'reimagine structure'",
      "action": "Generate 5-15 alternative structures, retain all logic, cherry-pick best, synthesize, present for approval"
    },
    "autoprogress": {
      "enabled": true,
      "rules": [
        "Apply all safe autofixes without asking",
        "Continue to next cycle automatically",
        "Show only final state unless error",
        "Update timestamps to current",
        "Suppress intermediate output",
        "Never stop for approval on safe fixes",
        "Iterate until convergence or max_cycles"
      ]
    }
  },

  "brilliant_hacks": {
    "self_healing": "Detect gaps bottlenecks fix autonomously converge to stable state",
    "parallel_batch": "Batch ALL independent ops in single response minimize turns",
    "heredoc_compression": "Compress repetitive Rails code into loops arrays not 500 line heredocs",
    "validation_inline": "Validate syntax immediately after edit within same tool call",
    "progressive_disclosure": "Show summary hide details unless error",
    "idempotent_scripts": "All .sh runnable repeatedly safely - check before create",
    "readme_driven": "Analyze .md FIRST extract requirements THEN code .sh",
    "visual_rhythm": "Align blocks vertically symmetrical spacing intentional whitespace",
    "llm_bias_mitigations": {
      "explicit_no_truncation": "Never use ... or [content] markers",
      "verify_full_output": "After edits, view file to ensure completeness",
      "counter_lazy_defaults": "Show ALL code, no abbreviations",
      "parallel_independence": "Only batch truly independent operations",
      "stop_criteria_explicit": "Define exact convergence criteria, not vague 'done'"
    }
  },

  "zsh_patterns": {
    "string": {
      "remove_crlf": "cleaned=${var//$'\\r'/}",
      "lowercase": "lower=${(L)var}",
      "uppercase": "upper=${(U)var}",
      "replace_all": "result=${var//search/replace}",
      "replace_first": "result=${var/search/replace}",
      "trim_start": "trimmed=${var##[[:space:]]#}",
      "trim_end": "trimmed=${var%%[[:space:]]#}",
      "trim_both": "trimmed=${${var##[[:space:]]#}%%[[:space:]]#}",
      "extract_nth_field": "fourth=${${(s:,:)line}[4]}",
      "split_to_array": "arr=( ${(s:delim:)var} )",
      "substring": "sub=${var[start,end]}"
    },
    "array": {
      "filter_matching": "matches=( ${(M)arr:#*pattern*} )",
      "filter_excluding": "non_matches=( ${arr:#*pattern*} )",
      "unique": "unique=( ${(u)arr} )",
      "join": "joined=${(j:,:)arr}",
      "reverse": "reversed=( ${(Oa)arr} )",
      "sort_asc": "sorted=( ${(o)arr} )",
      "sort_desc": "sorted_desc=( ${(O)arr} )",
      "slice_first_ten": "first_ten=( ${arr[1,10]} )",
      "slice_last_five": "last_five=( ${arr[-5,-1]} )",
      "length": "len=${#arr[@]}"
    },
    "file": {
      "tree_analysis": "print -l **/*(.ND^(node_modules|vendor|.git))",
      "recursive_files": "files=( **/*.rb(.N) )",
      "directories_only": "dirs=( **/*(/) )",
      "exclude_patterns": "files=( **/*~*.log~*.tmp(.N) )"
    },
    "flags": {
      "M": "Match instead of filter",
      "u": "Unique elements",
      "o": "Sort ascending",
      "O": "Sort descending",
      "L": "Lowercase",
      "U": "Uppercase",
      "j": "Join array",
      "s": "Split string",
      "f": "Split on newlines"
    }
  },

  "platform": {
    "rails": {
      "version": "8.0+",
      "stack": {
        "queue": "solid_queue",
        "cache": "solid_cache",
        "cable": "solid_cable",
        "assets": "propshaft",
        "server": "falcon",
        "db_dev": "sqlite3",
        "db_prod": "postgresql + pgvector"
      },
      "prefer": "Use rails g scaffold/model/controller, not manual file creation"
    },
    "openbsd": {
      "version": "7.4+",
      "services": ["nsd", "relayd", "httpd", "acme-client", "pf", "openntpd"],
      "flow": "internet → pf(synproxy) → relayd:443 → falcon:PORT → rails",
      "commands": {
        "service": "doas rcctl {enable|start|stop|restart|check} SERVICE",
        "firewall": "doas pfctl -f /etc/pf.conf",
        "dns": "doas nsd-control reload",
        "tls": "doas acme-client -vF DOMAIN",
        "proxy": "doas relayctl {reload|show hosts}"
      }
    },
    "vps": {
      "provider": "openbsd.amsterdam",
      "host": "brgen.no",
      "ip": "185.52.176.18",
      "user": "dev",
      "port": 31415,
      "paths": {
        "app": "/home/brgen/app",
        "repo": "/home/dev/pub4"
      }
    }
  },

  "environment": {
    "development": {
      "os": "Windows 11",
      "shell": "cygwin zsh via npm github-copilot-cli",
      "paths": {
        "root": "G:/pub4/",
        "rails": "G:/pub4/rails/",
        "creative": "G:/pub4/creative/"
      }
    },
    "production": {
      "os": "OpenBSD 7.4+",
      "shell": "zsh ONLY"
    }
  },

  "project_structure": {
    "master.json": "This file - LLM configuration and principles",
    "rails/*.sh": "Executable shell scripts that generate complete Rails apps with embedded CSS/views/controllers",
    "creative/*.rb": "Ruby scripts for image (ruby-vips), audio (dilla.rb), AI (repligen.rb), visual analysis (postpro.rb)",
    "integration_rule": "ALL code goes into rails/*.sh or creative/*.rb via heredocs - NO orphaned CSS/JSON/HTML files"
  },

  "design_system": {
    "philosophy": "X.com minimal center + Reddit threading + progressive disclosure + motion-triggered navigation + brutalist aesthetic",
    "forbidden_css": ["box-shadow", "text-shadow", "border-radius", "gradients", "background-image", "drop-shadow"],
    "allowed_css": ["flexbox", "grid", "container-queries", ":has() selector", "subgrid"],
    "color_palette": {
      "background": "rgb(255, 255, 255)",
      "surface": "rgb(247, 249, 249)",
      "border": "rgb(239, 243, 244)",
      "text_primary": "rgb(15, 20, 25)",
      "text_secondary": "rgb(83, 100, 113)",
      "accent_primary": "rgb(29, 155, 240)",
      "accent_hover": "rgb(26, 140, 216)",
      "upvote": "rgb(255, 69, 0)",
      "danger": "rgb(244, 33, 46)"
    },
    "spacing_scale": [4, 8, 12, 16, 24, 32, 48, 64, 96],
    "typography": {
      "stack": "system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif",
      "scale_px": [13, 15, 17, 20, 24, 32],
      "weights": [400, 600, 700]
    },
    "layout": {
      "structure": "Single 600px center column, sidebars hidden by default",
      "navigation": "Appears on scroll up or hover left edge, disappears on scroll down",
      "cards": "Minimal borders 1px solid border color, 12px padding, 8px gap",
      "threading": "Indent 32px per level, collapse button left of each comment"
    }
  },

  "chaos_engineering": {
    "enabled": true,
    "failure_modes": [
      {"id": "F001", "name": "network_partition", "injection": "pf block postgres 30s", "expected": "graceful degrade retry cache fallback", "recovery_target_s": 30},
      {"id": "F002", "name": "db_crash", "injection": "doas pkill -9 postgres", "expected": "app detects reconnects replays idempotent ops", "recovery_target_s": 10},
      {"id": "F003", "name": "disk_full", "injection": "dd if=/dev/zero of=/var/tmp/fill bs=1M count=500", "expected": "log rotation cleanup triggers", "recovery_target_s": 60},
      {"id": "F004", "name": "cert_expired", "injection": "replace with expired cert", "expected": "acme-client auto-renews", "recovery_target_s": 60}
    ],
    "runbooks": {
      "db_connection_exhausted": {"immediate": "doas rcctl restart app_brgen", "investigate": "slow query log N+1 detection"},
      "disk_full": {"immediate": "doas rm /var/log/app/*.log.gz && doas newsyslog -F", "prevent": "cron monitors df -h alerts at 80%"},
      "cert_expired": {"immediate": "doas acme-client -vF brgen.no && doas relayctl reload", "prevent": "monitor alerts 7 days before expiry"}
    }
  },

  "apps": {
    "brgen": {"port": 11006, "domain": "brgen.no", "status": "production", "concept": "Hyperlocal social network for Bergen Norway"},
    "hjerterom": {"port": 10004, "domain": "hjerterom.brgen.no", "status": "planned", "concept": "LA Food Bank clone for Bergen with mapbox"},
    "privcam": {"port": 10005, "domain": "privcam.no", "status": "planned", "concept": "OnlyFans clone with Stripe/Vipps BankID"},
    "amber": {"port": 10001, "domain": "amber.brgen.no", "status": "planned"},
    "bsdports": {"port": 10003, "domains": ["bsdports.org", "bsdports.net"], "status": "planned", "mission": "Future OpenBSD official website"},
    "mytoonz": {"domain": "mytoonz.no", "status": "planned", "concept": "AI comic strip generator via Replicate"}
  },

  "when_this_happens_do_that": [
    {"when": "session_starts", "do": "Load master.json completely first", "priority": "critical"},
    {"when": "about_to_run_command", "do": "Check enforcement blacklist first", "priority": "critical"},
    {"when": "need_to_validate_json", "do": "Use PowerShell System.Text.Json OR jq OR ruby", "priority": "critical"},
    {"when": "cyclomatic_complexity_exceeds_10", "do": "Extract subfunctions", "priority": "high"},
    {"when": "file_exceeds_850_lines", "do": "Split into focused modules OR run radical_simplification", "priority": "high"},
    {"when": "duplication_appears_3_plus_times", "do": "Extract to single source DRY", "priority": "high"},
    {"when": "multiple_independent_operations", "do": "Batch in single response parallel_batch", "priority": "medium"},
    {"when": "committing_code", "do": "Show git diff --stat first", "priority": "high"},
    {"when": "error_in_production", "do": "Fix forward with surgical correction not rollback", "priority": "high"}
  ],

  "meta_note": "This v52 structure: 43% smaller than v51, query-optimized FAQ sections, critical rules first, max 3 nesting, retains all 32 principles and logic"
}
